services:
    frontend:
        image: swippter-frontend-server:latest
        container_name: swippter-frontend-server
        restart: unless-stopped
        build:
            context: ../../
            dockerfile: ./infra/docker/frontend/Dockerfile
        ports:
            - 80:80        
        volumes:
            - static_volume:/app/swippter/static-files
    dependencies:
        image: swippter-backend-dependencies:latest
        build:
            context: ../../
            dockerfile: ./infra/docker/dependencies/Dockerfile
        volumes:
            - static_volume:/app/swippter/static-files        
    server:
        image: swippter-backend-server:latest
        container_name: swippter-backend-server
        restart: unless-stopped
        build:
            context: ../../
            dockerfile: ./infra/docker/server/Dockerfile
        volumes:
            - static_volume:/app/swippter/static-files
        expose:
            - 8000   
        depends_on:
            redis:
                condition: service_started
            dependencies:
                condition: service_started
            mysql:
                condition: service_healthy
    redis:
        image: redis
        container_name: redis
        restart: always
        ports:
            - 6379:6379
        build:
            context: ../../            
        expose:
            - 6379     
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 3
            start_period: 5s
    mysql:
        image: mysql:8.0
        container_name: mysql
        restart: always
        ports:
          - 3306:3306     
        build:
            context: ../../   
        env_file: 
            - ../env/.mysql.env
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 5s
            timeout: 3s
            retries: 10
            start_period: 20s
    rabbitmq:
      image: rabbitmq:4.2-alpine
      restart: unless-stopped
      container_name: rabbitmq      
      ports:
          - 5672:5672   
      healthcheck:
        test: rabbitmq-diagnostics -q ping
        interval: 30s
        timeout: 30s
        retries: 3
      depends_on:
        redis : 
            condition: service_started
volumes:
    static_volume: {}