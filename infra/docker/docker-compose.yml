services:
    frontend:
        image: swippter-frontend-server:latest
        container_name: swippter-frontend-server
        restart: unless-stopped
        build:
            context: ../../
            dockerfile: ./infra/docker/frontend/Dockerfile
        ports:
            - 80:80        
        volumes:
            - static_volume:/app/swippter/static-files
    dependencies:
        image: swippter-backend-dependencies:latest
        build:
            context: ../../
            dockerfile: ./infra/docker/dependencies/Dockerfile
        volumes:
            - static_volume:/app/swippter/static-files        
    server:
        image: swippter-backend-server:latest
        container_name: swippter-backend-server
        restart: unless-stopped
        build:
            context: ../../
            dockerfile: ./infra/docker/server/Dockerfile
        volumes:
            - static_volume:/app/swippter/static-files
        expose:
            - 8000   
        environment:
            - OTEL_SERVICE_NAME=swippter-backend  # Add this
            - OTEL_EXPORTER_OTLP_ENDPOINT=grpc://otel-collector:4317
            - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=grpc://otel-collector:4317
            - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=grpc://otel-collector:4317
            - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
            - OTEL_EXPORTER_OTLP_INSECURE=true
        depends_on:
            redis:
                condition: service_started
            dependencies:
                condition: service_started
            mysql:
                condition: service_healthy
    redis:
        image: redis
        container_name: redis
        restart: always
        ports:
            - 6379:6379
        build:
            context: ../../            
        expose:
            - 6379     
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 3
            start_period: 5s
    mysql:
        image: mysql:8.0
        container_name: mysql
        restart: always
        ports:
          - 3306:3306     
        build:
            context: ../../   
        env_file: 
            - ../env/.mysql.env
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 5s
            timeout: 3s
            retries: 10
            start_period: 20s
    rabbitmq:
      image: rabbitmq:4.2-alpine
      restart: unless-stopped
      container_name: rabbitmq      
      ports:
          - 5672:5672   
      healthcheck:
        test: rabbitmq-diagnostics -q ping
        interval: 30s
        timeout: 30s
        retries: 3
      depends_on:
        redis : 
            condition: service_started
    otel-collector:
        image: otel/opentelemetry-collector-contrib
        container_name: otel-collector
        command: [ "--config=/etc/otelcol/config.yaml" ]
        volumes:
            - ./otel-collector-config.yaml:/etc/otelcol/config.yaml
        ports:
            - "4317:4317"
            - "4318:4318"
    promtail:
        image: grafana/promtail
        container_name: promtail
        volumes:
            - ./promtail-config.yaml:/etc/promtail/config.yml
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock
        depends_on:
            - loki
    loki:
        image: grafana/loki
        container_name: loki
        ports:
            - "3100:3100"
    tempo:
        image: grafana/tempo
        container_name: tempo
        ports:
            - "3200:3200"
        volumes:
            - ./tempo-config.yaml:/etc/tempo/tempo.yaml
        command:
            - "-config.file=/etc/tempo/tempo.yaml"
    grafana:
        image: grafana/grafana
        container_name: grafana
        ports:
            - "3000:3000"
        volumes:
            - ./grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
        depends_on:
            - loki
            - tempo
            - otel-collector
    prometheus:
        image: prom/prometheus
        container_name: prometheus
        ports:
            - "9090:9090"
        volumes:
            - ./prometheus-config.yaml:/etc/prometheus/prometheus.yml
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
volumes:
    static_volume: {}